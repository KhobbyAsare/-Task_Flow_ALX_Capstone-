{% extends 'base.html' %}

{% block title %}Edit Task - {{ task.title }} - Task Flow{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-pencil-square"></i> Edit Task</h1>
    <div>
        <a href="/web/tasks/{{ task.id }}/" class="btn btn-outline-info me-2">
            <i class="bi bi-eye"></i> View Task
        </a>
        <a href="/web/tasks/" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Tasks
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-pencil"></i> Edit Task Details
                    {% if task.is_completed %}
                        <span class="badge bg-success ms-2">Completed</span>
                    {% elif task.is_overdue %}
                        <span class="badge bg-danger ms-2">Overdue</span>
                    {% else %}
                        <span class="badge bg-warning ms-2">Pending</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="taskEditForm">
                    {% csrf_token %}
                    
                    <!-- Title Field -->
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            {{ form.title.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.title }}
                        {% if form.title.help_text %}
                            <div class="form-text">{{ form.title.help_text }}</div>
                        {% endif %}
                        {% if form.title.errors %}
                            <div class="text-danger small">
                                {% for error in form.title.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Description Field -->
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.help_text %}
                            <div class="form-text">{{ form.description.help_text }}</div>
                        {% endif %}
                        {% if form.description.errors %}
                            <div class="text-danger small">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Priority and Category Row -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">
                                    {{ form.priority.label }}
                                </label>
                                {{ form.priority }}
                                {% if form.priority.help_text %}
                                    <div class="form-text">{{ form.priority.help_text }}</div>
                                {% endif %}
                                {% if form.priority.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.priority.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.category.id_for_label }}" class="form-label">
                                    {{ form.category.label }}
                                </label>
                                {{ form.category }}
                                {% if form.category.help_text %}
                                    <div class="form-text">{{ form.category.help_text }}</div>
                                {% endif %}
                                {% if form.category.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.category.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Due Date Row -->
                    <div class="mb-3">
                        <label for="{{ form.due_date.id_for_label }}" class="form-label">
                            {{ form.due_date.label }}
                        </label>
                        {{ form.due_date }}
                        {% if form.due_date.help_text %}
                            <div class="form-text">{{ form.due_date.help_text }}</div>
                        {% endif %}
                        {% if form.due_date.errors %}
                            <div class="text-danger small">
                                {% for error in form.due_date.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Submit Buttons -->
                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="/web/tasks/{{ task.id }}/" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-{% if task.is_completed %}warning{% else %}success{% endif %} me-2" 
                                    onclick="toggleTaskComplete({{ task.id }})">
                                {% if task.is_completed %}
                                    <i class="bi bi-arrow-counterclockwise"></i> Mark Incomplete
                                {% else %}
                                    <i class="bi bi-check-circle"></i> Mark Complete
                                {% endif %}
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Task Information -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Task Information</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Created:</strong><br>
                        <small class="text-muted">{{ task.created_at|date:"F d, Y \a\t g:i A" }}</small>
                    </div>
                    <div class="col-md-4">
                        <strong>Last Updated:</strong><br>
                        <small class="text-muted">{{ task.updated_at|date:"F d, Y \a\t g:i A" }}</small>
                    </div>
                    <div class="col-md-4">
                        {% if task.is_completed and task.completed_at %}
                            <strong>Completed:</strong><br>
                            <small class="text-success">{{ task.completed_at|date:"F d, Y \a\t g:i A" }}</small>
                        {% else %}
                            <strong>Status:</strong><br>
                            {% if task.is_overdue %}
                                <small class="text-danger">Overdue</small>
                            {% else %}
                                <small class="text-warning">Pending</small>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="card mt-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Danger Zone</h6>
            </div>
            <div class="card-body">
                <p class="card-text">
                    Deleting a task is permanent and cannot be undone. All task data will be lost.
                </p>
                <button type="button" class="btn btn-outline-danger" onclick="deleteTask({{ task.id }})">
                    <i class="bi bi-trash"></i> Delete Task
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Form validation
    $('#taskEditForm').on('submit', function(e) {
        const title = $('#{{ form.title.id_for_label }}').val().trim();
        
        if (title.length < 3) {
            e.preventDefault();
            alert('Task title must be at least 3 characters long.');
            $('#{{ form.title.id_for_label }}').focus();
            return false;
        }
        
        // Show loading state
        const submitButton = $(this).find('button[type="submit"]');
        submitButton.prop('disabled', true);
        submitButton.html('<i class="bi bi-hourglass-split"></i> Saving...');
        
        // Re-enable button after 5 seconds in case of error
        setTimeout(function() {
            submitButton.prop('disabled', false);
            submitButton.html('<i class="bi bi-check-circle"></i> Save Changes');
        }, 5000);
    });
    
    
    // Character counter for title
    $('#{{ form.title.id_for_label }}').on('input', function() {
        const length = $(this).val().length;
        const maxLength = 200;
        const remaining = maxLength - length;
        
        let counterHtml = `<small class="text-muted">${length}/${maxLength} characters`;
        if (remaining < 20) {
            counterHtml = `<small class="text-warning">${length}/${maxLength} characters`;
        }
        if (remaining < 0) {
            counterHtml = `<small class="text-danger">${length}/${maxLength} characters - Too long!`;
        }
        counterHtml += '</small>';
        
        // Remove existing counter and add new one
        $(this).siblings('.char-counter').remove();
        $(this).after(`<div class="char-counter">${counterHtml}</div>`);
    });
    
    // Confirm form changes before leaving
    let formChanged = false;
    $('#taskEditForm input, #taskEditForm textarea, #taskEditForm select').on('change input', function() {
        formChanged = true;
    });
    
    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    // Reset form changed flag on submit
    $('#taskEditForm').on('submit', function() {
        formChanged = false;
    });
});

function toggleTaskComplete(taskId) {
    if (confirm('Are you sure you want to change the completion status of this task?')) {
        axios.post(`/web/tasks/${taskId}/toggle/`, {}, {
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(function (response) {
            if (response.data.success) {
                location.reload();
            }
        })
        .catch(function (error) {
            console.error('Error:', error);
            alert('Error updating task status');
        });
    }
}

function deleteTask(taskId) {
    const taskTitle = '{{ task.title|escapejs }}';
    if (confirm(`Are you sure you want to permanently delete the task "${taskTitle}"? This action cannot be undone.`)) {
        if (confirm('This will permanently delete the task. Are you absolutely sure?')) {
            axios.delete(`/web/tasks/${taskId}/`, {
                headers: {
                    'X-CSRFToken': csrftoken
                }
            })
            .then(function (response) {
                if (response.data.success) {
                    // Redirect to task list
                    window.location.href = '/web/tasks/';
                }
            })
            .catch(function (error) {
                console.error('Error:', error);
                alert('Error deleting task');
            });
        }
    }
}
</script>
{% endblock %}
